# SuperHAT V2

A HAT (hardware attached on top) for the Raspberry Pi 4 & 5. 

---

## Power Rail Breakdown

SuperHAT receives external 5V and 12V power (with a common ground) from an [MR30 connector](https://www.tme.com/us/en-us/details/mr30pw-m/dc-power-connectors/amass/). 12V is used for tools and motors. 5V is used for tools, servos, and powering the Raspberry Pi. When using the SuperHAT, do not plug in a USB-C power supply. 

---

## Feature Overview

1. **Four** N-type MOSFETs for GPIO switching 5V or 12V tools.
2. **Six** connectors for I²C interfacing.
3. **One** dual H-bridge 12V motor driver.
4. **One** stepper motor driver
5. **Two** 5V servo connectors
6. Overvoltage Protection
7. Voltage & Current Sensing

### 1. MOSFET GPIO Switching

#### Schematic

<img width="1280" height="1063" alt="Screenshot 2025-07-22 175952" src="https://github.com/user-attachments/assets/540220be-7223-49e9-9d6d-b81cf61d3f2c" />

#### N-Type MOSFET

The N-type MOSFET ([AOSS32136C](https://www.digikey.com/en/products/detail/alpha-omega-semiconductor-inc/AOSS32136C/11567433)) in the schematic is routed for low-side switching. When testing, switching on the high side (before the load), resulted in a voltage drop. In an underwater environment, employing low-side switching means that the wires leading to the tool will be high (5V or 12V) when the tool is idling. 

#### Back-EMF Protection

There is a standard diode ([GSD2004WS-HE3-08](https://www.digikey.com/en/products/detail/vishay-general-semiconductor-diodes-division/GSD2004WS-HE3-08/4831745?s=N4IgjCBcpgbFoDGUBmBDANgZwKYBoQB7KAbRABYAGSgJnIgKtoHZmQBdAgBwBcoQAyjwBOASwB2AcxABfArACcCEMkjps%2BIqQqUFAZn0dufSIJETpckAFZmlZavW4CxSGSrN9ADiMhe-ITEpWQIwBVYHVExnLTcQPTgFMBpff1NAixDwBS8laBUojRdte3YrGhpYCHzHaM1XMjAAAgA1JoABJrBqJoBbAEFUkxAAYUIAVy4MHAATAFVxUR4AeRQAWRw0LHHhHCyAWngaqBFx%2Bu0UsoJ9lOPIU-O46w4Zcu0Z0UIZvbKgA)) on the 5V and 12V lines. When the load is switched off, the diode prevents sensitive electronic components (the MOSFET in this case) from receiving voltage spikes generated by an inductive load (e.g. motor). 

#### 5V Configuration

To use a 5V you will need to solder the jumper (on the back of the board). Do not use a 12V tool when you solder the jumper because the 12V and 5V lines will short (because JP7 is closed and D3 leads to 5V). Technically, since MOSFETs can behave like variable resistors, and sending a PWM signal can "adjust" the voltage of the gate, it is possible to operate lower voltage tools. However, this is not recommended as there is no RC-filter at the gate to smooth these pulses. This RC-filter will be a feature in SuperHAT V3.

#### LED Indicator & Pulldown Resistor

In the schematic, there is an additional 10k $\Omega$ pulldown resistor in parallel with the LED circuit. This is because the LED can’t instantly pull down the voltage (since LEDs are non-ohmic). Intuitively, the green LED turns on when the GPIO is high. 

### 2. I²C Interfacing

#### Schematic

<img width="1624" height="839" alt="Screenshot 2025-07-22 200031" src="https://github.com/user-attachments/assets/4a1f0512-2bda-456b-9f5e-abe156ae1233" />

#### Connectors

To ensure connectivity with a wide range of devices, there are six "I²C connectors": two [right-angle JST-SH](https://www.digikey.com/en/products/detail/jst-sales-america-inc/SM04B-SRSS-TB/926710), two [vertical JST-SH](https://www.digikey.com/en/products/detail/jst-sales-america-inc/BM04B-SRSS-TB/926696), and two [right-angle JST-GH](https://www.digikey.com/en/products/detail/jst-sales-america-inc/SM04B-GHS-TB/807788) connectors. Note that JST-SH is  the same as STEMMA QT by Adafruit and Qwiic by Sparkfun. 

#### Pull-ups

There are no pullups for I²C on SuperHAT because the Raspberry Pi already incorporates 1.8k $\Omega$ pull-up resistors for SCL and SDA lines. 

#### 5V Device Support

Connector J10 is specifically designed for 5V I²C devices. While this connector provides 5V power to the device, the SDA and SCL logic lines remain at 3.3V levels. Ensure connected devices are 3.3V logic-compatible or include appropriate level-shifting circuitry.

### 3. Dual H-Bridge Motor Driver

#### Schematic

<img width="1382" height="463" alt="Screenshot 2025-07-22 201044" src="https://github.com/user-attachments/assets/0ed2abe9-3e32-4045-a5cd-937c07485991" />

#### Operation

A 12V brushed DC motor can be driven in both directions with the [DRV8871](https://www.digikey.com/en/products/detail/texas-instruments/DRV8871DDARQ1/7244177?s=N4IgTCBcDaICICUBqAOFB2AjHOBBBAipiALoC%2BQA) motor driver. Input pins are set to GPIOs 9 and 10. To drive the motor, set one of the pins to high, and the other to low. Flip the status of both pins to drive the motor in the opposite direction. The motor won't move went both GPIOs are set to low. The 30k $\Omega$ resistor on pin 4 (ILIM) results in a trip current of about 2A (64 (kV) / R<sub>ILIM</sub> (k $\Omega$)). 

### 4. Stepper Motor Driver

#### Schematic

<img width="1423" height="1115" alt="Screenshot 2025-07-22 205711" src="https://github.com/user-attachments/assets/76e2d56c-b29b-4c73-845d-f23951c78018" />

#### Operation

A 12V stepper motor can be driven by this motor driver ([DRV8825](https://www.digikey.com/en/products/detail/texas-instruments/DRV8825PWPR/2695909)). The pins for operation are GPIOs 21 and 26. Pulse GPIO 21 to move the stepper motor and set GPIO 26 to low or high to determine the direction of rotation. To test the stepper motor, run this code: https://github.com/Harry-IV/superhat_test/blob/main/stepper_motor.py.

#### Settings

To adjust the current limiting, use the screwhead on the potentiometer. The current limit is the voltage read on the screw head of the potentiometer multiplied by 2. To disable the stepper motor driver, solder jumper JP6. 

#### Cooling

This IC gets hot, especially at higher currents. It would be wise to put a heat-sink.

### 5. Servo Driving

#### Schematic

<img width="690" height="650" alt="Screenshot 2025-07-29 173046" src="https://github.com/user-attachments/assets/5851c40c-1f9a-4056-ab17-e3fa655001e2" />

#### Operation

GPIOs 12 and 13 can each drive one servo motor (a total of two for SuperHAT). Having a direct connection, especially with a Raspberry Pi due to their timing inconsistencies, can lead to jitter. This can be mitigated by using the [pigpio library](https://abyz.me.uk/rpi/pigpio/) or by "sleeping" the pin while not moving the servo. 

### 6. Overvoltage Protection

#### Schematic

<img width="1749" height="1148" alt="Screenshot 2025-07-29 173822" src="https://github.com/user-attachments/assets/b87bddad-19a9-4591-8e2b-eb442354caa4" />

#### Undervoltage Lockout (UVLO)

The [TPS259621](https://www.digikey.com/en/products/detail/texas-instruments/TPS259621DDAR/10445382) will cut off power to the Raspberry Pi completely if the EN/UVLO pin does not receive a voltage above 1.2V (when rising). The UVLO threshold is set by a voltage divider consisting of resistors R18 (7.5kΩ) and R19 (2.61kΩ). These values yield an undervoltage cutoff of 4.85V. Note that the undervoltage cutoff when falling will be lower since it will cut off when the EN/UVLO pin does not receive a voltage above 1.1V. Ultimately, this part of the circuit isn’t really that necessary.

#### Overvoltage Clamping

What is more necessary is the overvoltage component. Here, there is no voltage divider. Texas Instrument's documentation calls for a 400k ohm resistor for the output clamp voltage to be 5.45V, but a 470k ohm resistor is used instead because they are a lot easier to come by. 

#### Additional Resources

Video explanation by GreatScott!: https://www.youtube.com/watch?v=JOhQ3nsR7xo&t=440s 

### 7. Voltage and Current Sensing

#### Schematic

<img width="1098" height="1040" alt="image" src="https://github.com/user-attachments/assets/12ad3954-1702-469a-a8c4-c3d5865348be" />

#### INA3221

The [INA3221](https://www.digikey.com/en/products/detail/texas-instruments/INA3221AQRGVRQ1/5995432) is a digital power-sensing IC that communicates via I²C. It features 3 channels, which are used to measure the voltage and current on the 3.3V, 5V, and 12V rails. 

#### Shunt Resistors

Two 0.04 Ω resistors are placed at the 5V and 12V lines near the MR30 connector. All 5V and 12V power on the SuperHAT flows through these two shunts. This includes power draw at 5V from the Pi. A third 0.04 Ω resistor is placed on the 3.3V line near the 3.3V pin from the Raspberry Pi. This does not measure how much current the Pi draws at 3.3V, but rather how much SuperHAT draws (with I²C devices mainly).

#### Testing

To test the INA3221, run this code, which uses Adafruit's INA3221 library: [https://github.com/Harry-IV/superhat_test/tree/main/INA3221]

---

## PCB Layout

### 4-layer Stackup

| Layer | Type                      |
| ----- | ------------------------- |
| 1     | Signal                    |
| 2     | Ground                    |
| 3     | Power (3.3V, 5V, 12V)     |
| 4     | Signal                    |

<img width="974" height="557" alt="image" src="https://github.com/user-attachments/assets/fa8a4fbc-dcbf-49d9-a1bc-13df2b86374b" />

### Design Notes

* Via-in-pad is used to condense routing.
* Copper pours help with thermal dissipation.

---

Email me at harry.c.ohagin@gmail.com if you have any questions. 



